<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="/css/index.css">
</head>

<body>
    <div id="index">
        <%- include("aside.ejs") %>
            <div id="central">
                <div id="nav-search">
                    <div id="search">
                        <input type="text">
                        <div id="deleteSearch"><svg width="25px" height="25px" viewBox="0 0 24 24" id="Layer_1"
                                data-name="Layer 1" xmlns="http://www.w3.org/2000/svg">
                                <defs>
                                    <style>
                                        .cls-1 {
                                            fill: none;
                                            stroke: #020202;
                                            stroke-miterlimit: 10;
                                            stroke-width: 1.91px;
                                        }
                                    </style>
                                </defs>
                                <circle class="cls-1" cx="9.14" cy="9.14" r="7.64" />
                                <line class="cls-1" x1="22.5" y1="22.5" x2="14.39" y2="14.39" />
                            </svg></div>

                    </div>
                </div>
                <div id="videosIndex">
                    <div class="video">
                        <video id="video" width="1220" height="640" controls preload="metadata">
                            <!-- Utiliza la URL data: para mostrar el video codificado en base64 -->
                            <source src="data:video/mp4;base64, <%= video.videoUrl %>" type="video/mp4">
                            Tu navegador no soporta la etiqueta de video.
                        </video>
                        <div class="videoOpc">
                            <div class="likeDiv" videoId=<%=video.id %>>
                                <div class="contLike">
                                    <%= video.likes %>
                                </div>
                                <button type="button" onclick="darLike(event)" class="like">
                                    <?xml version="1.0" encoding="utf-8"?>
                                    <!-- License: PD. Made by Mary Akveo: https://maryakveo.com/ -->
                                    <svg fill="#000000" width="30px" height="30px" viewBox="0 0 24 24" id="like"
                                        data-name="Flat Color" xmlns="http://www.w3.org/2000/svg"
                                        class="icon flat-color">
                                        <path id="primary"
                                            d="M21.36,9.15A3,3,0,0,0,19,8H17.07c0-.82.06-1.8,0-2.79A3.31,3.31,0,0,0,13.77,2a3.22,3.22,0,0,0-3.13,2.48C10.3,6,9.93,7.24,9.57,8.32a1,1,0,0,1-1,.68H7a1,1,0,0,0-1,1V20a1,1,0,0,0,.53.88A10.65,10.65,0,0,0,11.24,22h4.2a5,5,0,0,0,4.85-3.79l1.62-6.48A3,3,0,0,0,21.36,9.15Z"
                                            fill=<% if(video.tipolike=="like" ){ %>
                                            <%= "aqua" %>
                                                <% }else { %>
                                                    <%= "white" %>
                                                        <% } %> %>
                                                            stroke="black">
                                        </path>
                                        <rect id="secondary" x="2" y="8" width="6" height="14" rx="1" fill="white"
                                            stroke="black"></rect>
                                    </svg>
                                </button>

                                <button type="button" onclick="darLike(event)" class="dislike">
                                    <?xml version="1.0" encoding="utf-8"?>
                                    <!-- License: PD. Made by Mary Akveo: https://maryakveo.com/ -->
                                    <svg fill="#000000" width="30px" height="30px" viewBox="0 0 24 24" id="dislike"
                                        data-name="Flat Color" xmlns="http://www.w3.org/2000/svg"
                                        class="icon flat-color">
                                        <path id="primary"
                                            d="M21.36,14.85A3,3,0,0,1,19,16H17.07c0,.82.06,1.8,0,2.79A3.31,3.31,0,0,1,13.77,22a3.22,3.22,0,0,1-3.13-2.48c-.34-1.47-.71-2.76-1.07-3.84a1,1,0,0,0-1-.68H7a1,1,0,0,1-1-1V4a1,1,0,0,1,.53-.88A10.65,10.65,0,0,1,11.24,2h4.2a5,5,0,0,1,4.85,3.79l1.62,6.48A3,3,0,0,1,21.36,14.85Z"
                                            fill=<% if(video.tipolike=="dislike" ){ %>
                                            <%= "red" %>
                                                <% } else { %>
                                                    <%= "white" %>
                                                        <% } %> stroke="black">
                                        </path>
                                        <rect id="secondary" x="2" y="2" width="6" height="14" rx="1" fill="white"
                                            stroke="black"></rect>
                                    </svg>
                                </button>
                                <div class="contDislike">
                                    <%= video.dislikes %>
                                </div>
                                <!-- License: GPL. Made by Automattic: https://github.com/Automattic/gridicons -->
                                <button type="submit" style="margin-left: auto;" class="dislike">
                                    <svg width="30px" height="30px" viewBox="0 0 24 24"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <rect x="0" fill="white" width="24" height="24" />
                                        <g>
                                            <path
                                                d="M12 16l-5 5v-5H5c-1.1 0-2-.9-2-2V5c0-1.1.9-2 2-2h14c1.1 0 2 .9 2 2v9c0 1.1-.9 2-2 2h-7z"
                                                fill="white" stroke="black" />
                                        </g>
                                    </svg></button>
                                <%= video.cantidadComentarios %>

                            </div>
                        </div>




                    </div>

                    <div class="comentarios-container">

                        <div class="comentario">
                            <div class="comentar">
                                <img src="data:image/jpeg;base64,<%= foto %>">
                                <input id="comentarioEnviar" type="text" placeholder="Comenta el video">
                                <button type="button" onclick="comentar()">
                                    <?xml version="1.0" encoding="utf-8"?>
                                    <!-- License: CC Attribution. Made by Shannon E. Thomas: https://dribbble.com/shannonethomas -->
                                    <svg version="1.1" id="Uploaded to svgrepo.com" xmlns="http://www.w3.org/2000/svg"
                                        xmlns:xlink="http://www.w3.org/1999/xlink" width="30px" height="30px"
                                        viewBox="0 0 32 32" xml:space="preserve">
                                        <style type="text/css">
                                            .sharpcorners_een {
                                                fill: #ffffff;
                                            }

                                            .st0 {
                                                fill: #ffffff;
                                            }
                                        </style>
                                        <path class="sharpcorners_een" d="M23.35,8.463L11.085,19.881L9,27.85v-9.079L23.35,8.463z M27.857,3.993L1.911,12.642l6.677,5.193
                                        L27.857,3.993z M9.763,28.884l4.404-5.431l-2.479-1.925L9.763,28.884z M11.979,20.416l-0.017,0.066L22.57,28.71l6.636-24.335
                                        L11.979,20.416z" />
                                    </svg>
                                </button>
                            </div>

                        </div>

                        <% for( comentario of comentarios ) { %>
                            <div class="comentario" idComentario=<%=comentario.id %>>
                                <div class="info">
                                    <img src="data:image/jpeg;base64,<%= comentario.foto %>">
                                    <div class="in">
                                        <div class="autor">
                                            <%= comentario.nombre %>
                                        </div>
                                        <div class="metadatos">April 20, 2024</div>
                                    </div>

                                </div>

                                <div class="contenido">
                                    <%= comentario.comentario %>
                                </div>
                                <div style="display: flex;gap: 10px;">
                                    <p onclick="responderComentario(event)"
                                        style="font-size:medium; margin-top: 10px;font-weight: 600;">Responder</p>
                                    <p onclick="quitarComentario(event)"
                                        style="font-size:medium;color: red; margin-top: 10px;font-weight: 600;display: none;">
                                        Cancelar
                                    </p>
                                </div>

                                <div style="display: none;margin-bottom:10px" class="comentar">
                                    <img src="data:image/jpeg;base64,<%= foto %>">
                                    <input class="comentarioEnviar" type="text" placeholder="Comenta el video">
                                    <button type="button" onclick="subcomentar(event)">
                                        <?xml version="1.0" encoding="utf-8"?>
                                        <!-- License: CC Attribution. Made by Shannon E. Thomas: https://dribbble.com/shannonethomas -->
                                        <svg version="1.1" id="Uploaded to svgrepo.com"
                                            xmlns="http://www.w3.org/2000/svg"
                                            xmlns:xlink="http://www.w3.org/1999/xlink" width="30px" height="30px"
                                            viewBox="0 0 32 32" xml:space="preserve">
                                            <style type="text/css">
                                                .sharpcorners_een {
                                                    fill: #ffffff;
                                                }

                                                .st0 {
                                                    fill: #ffffff;
                                                }
                                            </style>
                                            <path class="sharpcorners_een" d="M23.35,8.463L11.085,19.881L9,27.85v-9.079L23.35,8.463z M27.857,3.993L1.911,12.642l6.677,5.193
                                            L27.857,3.993z M9.763,28.884l4.404-5.431l-2.479-1.925L9.763,28.884z M11.979,20.416l-0.017,0.066L22.57,28.71l6.636-24.335
                                            L11.979,20.416z" />
                                        </svg>
                                    </button>
                                </div>
                                <% if(comentario.subcomentarios.length !=0){ %>
                                    <div class="numCom" style="display: flex; gap: 5px;align-items: center;">
                                        <?xml version="1.0" encoding="utf-8"?>

                                        <!-- License: MIT. Made by H2D2 Design: https://github.com/h2d2-design/h2d2-shopicons -->
                                        <svg width="15px" height="15px" viewBox="0 0 48 48"
                                            xmlns="http://www.w3.org/2000/svg">

                                            <path d="M0 0h48v48H0z" fill="none" />
                                            <g id="Shopicon">
                                                <polygon
                                                    points="24,29.172 9.414,14.586 6.586,17.414 24,34.828 41.414,17.414 38.586,14.586 	" />
                                            </g>
                                        </svg><b> comentarios</b>
                                    </div>
                                    <% } %>
                                        <div style="display: none;" class="subcomentarios">

                                            <% for(subcomentario of comentario.subcomentarios){ %>

                                                <div class="subcomentario">
                                                    <div class="info">
                                                        <img
                                                            src="data:image/jpeg;base64,<%= subcomentario.base64sub %>">
                                                        <div class="in">
                                                            <div class="autor">
                                                                <%= subcomentario.nombreSub %>
                                                            </div>
                                                            <div class="metadatos">April 20, 2024</div>
                                                        </div>

                                                    </div>

                                                    <div class="contenido">
                                                        <%= subcomentario.subcomentario %>
                                                    </div>
                                                </div>

                                                <% } %>
                                        </div>
                            </div>
                            <% } %>





                    </div>
                </div>
                <div id="chat"></div>
            </div>

            <script src="/js/darLike.js"></script>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>
            <script>

                document.addEventListener("DOMContentLoaded", () => {

                    let comentarios = document.querySelector(".comentarios-container").children

                    Array.from(comentarios).forEach(comentario => {

                        let subcomentarios = comentario.querySelector(".subcomentarios");

                        if (subcomentarios) {

                            let cantCom = comentario.querySelector(".numCom")


                            if (cantCom) {

                                cantCom.addEventListener("click", (e) => {

                                    let opciones = [180, "block"];

                                    console.log(e.currentTarget)

                                    if (e.currentTarget.nextElementSibling.style.display == "block") {

                                        opciones = [0, "none"]
                                        console.log("llega")

                                    }

                                    gsap.to(e.currentTarget.children[0], {
                                        rotation: opciones[0],
                                        duration: 0.2,
                                        ease: "none",
                                        onComplete: function () {

                                            console.log(subcomentarios)
                                            subcomentarios.style.display = opciones[1]

                                        }
                                    });

                                })


                                let b = document.createElement("b")
                                b.textContent = subcomentarios.children.length

                                cantCom.children[0].insertAdjacentElement("afterend", b)

                            }


                        }

                    });

                })

                function responderComentario(e) {

                    let obj = e.currentTarget

                    let comentar = obj.parentNode.nextElementSibling

                    console.log(comentar)
                    gsap.fromTo(comentar, {

                        opacity: 0,
                    }, {

                        duration: 0.4,
                        opacity: 1,
                        display: "flex",
                        ease: "power4.easeOut",
                        onComplete: function () {

                            obj.nextElementSibling.style.display = "block"

                        }

                    })
                }

                function quitarComentario(e) {

                    let obj = e.currentTarget

                    obj.style.display = "none"

                    let comentar = obj.parentNode.nextElementSibling

                    console.log(comentar)


                    gsap.fromTo(comentar, {

                        opacity: 1,
                    }, {

                        duration: 0.4,
                        opacity: 0,
                        display: "none",
                        ease: "power4.easeOut",
                        onComplete: function () {



                        }

                    })
                }


                function comentar() {

                    let req = new FormData
                    req.append("comentario", document.getElementById("comentarioEnviar").value)
                    req.append("videoId", parseInt(document.querySelector(".likeDiv").getAttribute("videoId")))

                    fetch("/comentar", {

                        method: "post",
                        body: req

                    }).then(data => data.json()).then(data => {

                        document.getElementById("comentarioEnviar").value = "";
                        let comentario = document.createElement("div")
                        comentario.classList.add("comentario")
                        comentario.innerHTML = "<div class='info'><img src='data:image/jpeg;base64," + data.base64 + "',><div class='in'><div class='autor'>" + data.nombre + "</div><div class='metadatos'>April 20, 2024</div></div></div><div class='contenido'>" + data.comentario + "</div>"
                        document.querySelector(".comentario > .comentar").parentNode.insertAdjacentElement("afterend", comentario);
                        gsap.fromTo(comentario, {

                            opacity: 0,
                            width: "0%",
                            height: "0px",
                            overflow: "hidden",

                        }, {

                            duration: 1,
                            opacity: 1,
                            width: "100%",
                            height: comentario.scrollHeight + "px",
                            ease: "power4.easeOut",

                            onComplete: function () {

                            }

                        })

                    })


                }

                function subcomentar(e) {


                    let input = e.currentTarget.previousElementSibling

                    console.log();
                    let req = new FormData
                    req.append("comentario", input.value);
                    req.append("idComentario", input.parentNode.parentNode.getAttribute("idComentario"));


                    fetch("/subcomentar", {

                        method: "post",
                        body: req

                    }).then(data => data.json()).then(data => {

                        console.log(data)
                        document.getElementById("comentarioEnviar").value = "";
                        let comentario = document.createElement("div")
                        comentario.classList.add("subcomentario")
                        comentario.innerHTML = "<div class='info'><img src='data:image/jpeg;base64," + data.base64 + "',><div class='in'><div class='autor'>" + data.nombre + "</div><div class='metadatos'>April 20, 2024</div></div></div><div class='contenido'>" + data.comentario + "</div>"

                        console.log(input.parentNode.parentNode.children)

                        let subcomentariosDiv = input.parentNode.parentNode.querySelector(".subcomentarios")

                        subcomentariosDiv.prepend(comentario)

                        subcomentariosDiv.style.display = "block"

                        gsap.fromTo(comentario, {

                            opacity: 0,
                            width: "0%",
                            height: "0px",
                            overflow: "hidden",

                        }, {

                            duration: 1,
                            opacity: 1,
                            width: "100%",
                            height: comentario.scrollHeight + "px",
                            ease: "power4.easeOut",

                            onComplete: function () {

                            }

                        })

                    })
                }

            </script>




</body>

</html>